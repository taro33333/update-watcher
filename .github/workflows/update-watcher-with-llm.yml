name: Update Watcher with Smart Digest

on:
  schedule:
    - cron: "0 0 * * *"  # UTC 0æ™‚ = JST 9æ™‚
  workflow_dispatch:

jobs:
  notify-updates:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # smart-digest å‡¦ç†åˆ†ã‚’è¿½åŠ 

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: "go.mod"
          cache: false

      # smart-digest ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup smart-digest
        run: |
          git clone https://github.com/taro33333/smart-digest.git /tmp/smart-digest
          cd /tmp/smart-digest
          
          # ãƒ‡ãƒãƒƒã‚°: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’ç¢ºèª
          echo "=== Repository structure ==="
          ls -la
          echo "=== cmd directory ==="
          ls -la cmd/ || echo "cmd directory not found"
          
          # ä¾å­˜é–¢ä¿‚ã‚’è§£æ±º
          go mod download
          go mod tidy
          
          # ãƒ“ãƒ«ãƒ‰
          go build -o /tmp/smart-digest-bin ./cmd/smart-digest
          
          # ãƒ“ãƒ«ãƒ‰çµæœã‚’ç¢ºèª
          ls -lh /tmp/smart-digest-bin
          /tmp/smart-digest-bin --version

      # config.yaml ã‚’ç”Ÿæˆ
      - name: Create smart-digest config
        run: |
          cat > /tmp/smart-digest-config.yaml << 'EOF'
          llm_provider: "openai"
          api_key: "${{ secrets.OPENAI_API_KEY }}"
          model: "gpt-4o-mini"
          interests:
            - "Go"
            - "Rust"
            - "Kubernetes"
            - "Security"
            - "Performance"
          threshold: 75
          max_workers: 5
          rate_limit_per_second: 10
          EOF

      # update-watcher ã®å‡ºåŠ›ã‚’ smart-digest ã§å‡¦ç†
      - name: Run update watcher with smart-digest
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # update-watcher ã®å‡ºåŠ›ã‚’ smart-digest ã«ãƒ‘ã‚¤ãƒ—
          go run main.go --json | \
            /tmp/smart-digest-bin --config /tmp/smart-digest-config.yaml \
            > /tmp/digest.md

      # çµæœãŒã‚ã‚‹å ´åˆã®ã¿ Slack ã«æŠ•ç¨¿
      - name: Post to Slack
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          DIGEST=$(cat /tmp/digest.md)
          
          # çµæœãŒã‚ã‚‹å ´åˆã®ã¿æŠ•ç¨¿
          if [ -n "$DIGEST" ] && [ "$DIGEST" != "è©²å½“ã™ã‚‹è¨˜äº‹ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚" ]; then
            # Markdown ã‚’ JSON ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
            ESCAPED=$(echo "$DIGEST" | jq -Rs .)
            
            curl -X POST "$SLACK_WEBHOOK_URL" \
              -H 'Content-Type: application/json' \
              -d "{
                \"text\": \"ğŸ“¬ ä»Šæ—¥ã®é‡è¦ãªæ›´æ–° (AIåˆ†ææ¸ˆã¿)\",
                \"blocks\": [
                  {
                    \"type\": \"section\",
                    \"text\": {
                      \"type\": \"mrkdwn\",
                      \"text\": $ESCAPED
                    }
                  }
                ]
              }"
          else
            echo "ä»Šæ—¥ã¯é‡è¦ãªæ›´æ–°ãªã—ï¼ˆé–¾å€¤: 75ç‚¹ä»¥ä¸Šï¼‰"
          fi

      - name: Notify on failure
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d '{"text":"ğŸš¨ *Update Watcher ãŒå¤±æ•—ã—ã¾ã—ãŸ*\nãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸã€‚GitHubã®Actions ã‚¿ãƒ–ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œãƒšãƒ¼ã‚¸>"}'
