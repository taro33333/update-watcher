name: Update Watcher with Smart Digest (Ollama)

on:
  schedule:
    - cron: "0 0 * * *"  # UTC 0æ™‚ = JST 9æ™‚
  workflow_dispatch:

jobs:
  notify-updates:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Ollama ã¯ CPU ã§é…ã„ãŸã‚é•·ã‚ã«è¨­å®š

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.4'
          cache: false

      # Ollama ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh

          # Ollama ã‚µãƒ¼ãƒãƒ¼ã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§èµ·å‹•
          ollama serve &

          # ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã™ã‚‹ã¾ã§å¾…æ©Ÿ
          sleep 5

          # å‹•ä½œç¢ºèª
          ollama --version

      # è»½é‡ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆCPUç”¨ã«å°ã•ã„ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ï¼‰
      - name: Pull Ollama model
        run: |
          # phi3:mini ã¯è»½é‡ã§ CPU ã§ã‚‚æ¯”è¼ƒçš„é«˜é€Ÿ
          ollama pull phi3:mini

          # ãƒ¢ãƒ‡ãƒ«ä¸€è¦§ã‚’ç¢ºèª
          ollama list

      # smart-digest ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup smart-digest
        run: |
          git clone https://github.com/taro33333/smart-digest.git /tmp/smart-digest
          cd /tmp/smart-digest

          # ä¾å­˜é–¢ä¿‚ã‚’è§£æ±º
          go mod download

          # ãƒ“ãƒ«ãƒ‰
          go build -o /tmp/smart-digest-bin ./cmd/smart-digest

          # ç¢ºèª
          /tmp/smart-digest-bin --version || echo "Built successfully"

      # config.yaml ã‚’ Ollama ç”¨ã«ç”Ÿæˆ
      - name: Create smart-digest config for Ollama
        run: |
          cat > /tmp/smart-digest-config.yaml << 'EOF'
          llm_provider: "ollama"
          ollama_url: "http://localhost:11434"
          model: "phi3:mini"
          interests:
            - "Go"
            - "Rust"
            - "Kubernetes"
            - "Security"
            - "Performance"
            - "DevOps"
            - "Cloud Infrastructure"
          threshold: 70
          max_workers: 2
          rate_limit_per_second: 1
          EOF

          echo "=== Config ==="
          cat /tmp/smart-digest-config.yaml

      # update-watcher ã‚’ JSON ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ
      - name: Run update-watcher with JSON output
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # update-watcher ã‚’ --json ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ
          go run main.go --json > /tmp/urls.json 2>/tmp/watcher-error.log || true

          if [ -s /tmp/watcher-error.log ]; then
            echo "=== Update Watcher Logs ==="
            cat /tmp/watcher-error.log
          fi

          echo "=== Update Watcher JSON Output ==="
          cat /tmp/urls.json || echo "No output"

          # URLã®æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
          URL_COUNT=$(wc -l < /tmp/urls.json 2>/dev/null || echo "0")
          echo "Found $URL_COUNT URLs"

      # smart-digest ã§åˆ†æï¼ˆCPU ã®ãŸã‚ä¸Šä½10ä»¶ã«åˆ¶é™ï¼‰
      - name: Analyze with smart-digest (Ollama)
        run: |
          # URLãŒæŠ½å‡ºã§ããŸã‹ãƒã‚§ãƒƒã‚¯
          if [ ! -f /tmp/urls.json ] || [ ! -s /tmp/urls.json ]; then
            echo "ä»Šæ—¥ã¯æ–°ã—ã„æ›´æ–°ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚" > /tmp/digest.md
            echo "=== No URLs to analyze ==="
            exit 0
          fi

          # URLã®æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã—ã€CPUè² è·ã‚’è€ƒæ…®ã—ã¦ä¸Šä½10ä»¶ã«åˆ¶é™
          URL_COUNT=$(wc -l < /tmp/urls.json)
          echo "Total URLs: $URL_COUNT"

          if [ "$URL_COUNT" -gt 10 ]; then
            echo "Limiting to top 10 URLs for CPU performance"
            head -10 /tmp/urls.json > /tmp/urls-limited.json
            mv /tmp/urls-limited.json /tmp/urls.json
            URL_COUNT=10
          fi

          echo "=== Analyzing $URL_COUNT URLs with smart-digest (Ollama) ==="

          # Ollama ã‚µãƒ¼ãƒãƒ¼ãŒå‹•ä½œã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
          curl -s http://localhost:11434/api/tags || echo "Ollama server check"

          # smart-digest ã§åˆ†æ
          cat /tmp/urls.json | \
            /tmp/smart-digest-bin \
              --config /tmp/smart-digest-config.yaml \
              --verbose \
              > /tmp/digest.md 2>/tmp/digest-error.log || true

          echo "=== Smart Digest Output ==="
          cat /tmp/digest.md || echo "No output"

          if [ -s /tmp/digest-error.log ]; then
            echo "=== Smart Digest Errors ==="
            cat /tmp/digest-error.log
          fi

      # çµæœã‚’ Slack ã«æŠ•ç¨¿
      - name: Post to Slack
        if: success()
        env:
          AI_SLACK_WEBHOOK_URL: ${{ secrets.AI_SLACK_WEBHOOK_URL }}
        run: |
          if [ ! -f /tmp/digest.md ] || [ ! -s /tmp/digest.md ]; then
            echo "No digest to post"
            exit 0
          fi

          DIGEST=$(cat /tmp/digest.md)

          # è©²å½“è¨˜äº‹ãªã—ãƒã‚§ãƒƒã‚¯
          if echo "$DIGEST" | grep -q "è©²å½“ã™ã‚‹è¨˜äº‹ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ\|æ–°ã—ã„æ›´æ–°ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ"; then
            curl -X POST "$AI_SLACK_WEBHOOK_URL" \
              -H 'Content-Type: application/json' \
              -d '{"text":"ğŸ“­ ä»Šæ—¥ã®é‡è¦ãªæ›´æ–°ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆé–¾å€¤: 70ç‚¹ä»¥ä¸Šï¼‰"}'
            exit 0
          fi

          # Markdown ã‚’ JSON ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼ˆSlack ã®æ–‡å­—æ•°åˆ¶é™ã‚’è€ƒæ…®ï¼‰
          DIGEST_TRUNCATED=$(echo "$DIGEST" | head -c 2900)
          if [ ${#DIGEST} -gt 2900 ]; then
            DIGEST_TRUNCATED="$DIGEST_TRUNCATED\n\n_... (çœç•¥)_"
          fi

          ESCAPED=$(echo "$DIGEST_TRUNCATED" | jq -Rs .)

          curl -X POST "$AI_SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"ğŸ“¬ ä»Šæ—¥ã®é‡è¦ãªæ›´æ–° (AIåˆ†ææ¸ˆã¿ - Ollama)\",
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": $ESCAPED
                  }
                }
              ]
            }"

      - name: Notify on failure
        if: failure()
        env:
          AI_SLACK_WEBHOOK_URL: ${{ secrets.AI_SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST "$AI_SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d '{"text":"ğŸš¨ *Update Watcher ãŒå¤±æ•—ã—ã¾ã—ãŸ*\nãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸã€‚GitHubã®Actions ã‚¿ãƒ–ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œãƒšãƒ¼ã‚¸>"}'
