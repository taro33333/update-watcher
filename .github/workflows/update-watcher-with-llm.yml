name: Update Watcher with Smart Digest

on:
  schedule:
    - cron: "0 0 * * *"  # UTC 0æ™‚ = JST 9æ™‚
  workflow_dispatch:

jobs:
  notify-updates:
    runs-on: ubuntu-lates
    timeout-minutes: 40

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25.4"
          cache: false

      # smart-digest ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup smart-digest
        run: |
          git clone https://github.com/taro33333/smart-digest.git /tmp/smart-digest
          cd /tmp/smart-digest

          # ä¾å­˜é–¢ä¿‚ã‚’è§£æ±º
          go mod download

          # ãƒ“ãƒ«ãƒ‰
          go build -o /tmp/smart-digest-bin ./cmd/smart-digest

          # ç¢ºèª
          /tmp/smart-digest-bin --version || echo "Built successfully"

      # config.yaml ã‚’ OpenAI ç”¨ã«ç”Ÿæˆï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–æ¸ˆã¿ï¼‰
      - name: Create smart-digest config
        run: |
          cat > /tmp/smart-digest-config.yaml << 'EOF'
          llm_provider: "openai"
          api_key: "${{ secrets.OPENAI_API_KEY }}"
          model: "gpt-4o-mini"
          interests:
            - "Go"
            - "Rust"
            - "Kubernetes"
            - "Security"
            - "Performance"
            - "DevOps"
            - "Cloud Infrastructure"
          threshold: 70
          max_workers: 1
          rate_limit_per_second: 0.05
          EOF

          echo "=== Config (rate limit: 3 RPM) ==="
          cat /tmp/smart-digest-config.yaml

      # update-watcher ã‚’ JSON ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ
      - name: Run update-watcher with JSON output
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # update-watcher ã‚’ --json ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ
          go run main.go --json > /tmp/urls.json 2>/tmp/watcher-error.log || true

          if [ -s /tmp/watcher-error.log ]; then
            echo "=== Update Watcher Logs ==="
            cat /tmp/watcher-error.log
          fi

          echo "=== Update Watcher JSON Output ==="
          cat /tmp/urls.json || echo "No output"

          # URLã®æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
          URL_COUNT=$(wc -l < /tmp/urls.json 2>/dev/null || echo "0")
          echo "Found $URL_COUNT URLs"

      # smart-digest ã§åˆ†æï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–ã§ä¸Šä½30ä»¶ã«åˆ¶é™ï¼‰
      - name: Analyze with smart-digest
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # URLãŒæŠ½å‡ºã§ããŸã‹ãƒã‚§ãƒƒã‚¯
          if [ ! -f /tmp/urls.json ] || [ ! -s /tmp/urls.json ]; then
            echo "ä»Šæ—¥ã¯æ–°ã—ã„æ›´æ–°ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚" > /tmp/digest.md
            echo "=== No URLs to analyze ==="
            exit 0
          fi

          # URLã®æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã—ã€ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–ã§ä¸Šä½30ä»¶ã«åˆ¶é™
          URL_COUNT=$(wc -l < /tmp/urls.json)
          echo "Total URLs: $URL_COUNT"

          if [ "$URL_COUNT" -gt 30 ]; then
            echo "Limiting to top 30 URLs (rate limit: 3 RPM)"
            head -30 /tmp/urls.json > /tmp/urls-limited.json
            mv /tmp/urls-limited.json /tmp/urls.json
            URL_COUNT=30
          fi

          echo "=== Analyzing $URL_COUNT URLs with smart-digest ==="
          echo "Estimated time: ~$((URL_COUNT * 20 / 60)) minutes (rate limit: 3 RPM)"

          # smart-digest ã§åˆ†æ
          cat /tmp/urls.json | \
            /tmp/smart-digest-bin \
              --config /tmp/smart-digest-config.yaml \
              --verbose \
              > /tmp/digest.md 2>/tmp/digest-error.log || true

          echo "=== Smart Digest Output ==="
          cat /tmp/digest.md || echo "No output"

          if [ -s /tmp/digest-error.log ]; then
            echo "=== Smart Digest Errors ==="
            cat /tmp/digest-error.log
          fi

      # çµæœã‚’ Slack ã«æŠ•ç¨¿
      - name: Post to Slack
        if: success()
        env:
          AI_SLACK_WEBHOOK_URL: ${{ secrets.AI_SLACK_WEBHOOK_URL }}
        run: |
          if [ ! -f /tmp/digest.md ] || [ ! -s /tmp/digest.md ]; then
            echo "No digest to post"
            exit 0
          fi

          DIGEST=$(cat /tmp/digest.md)

          # è©²å½“è¨˜äº‹ãªã—ãƒã‚§ãƒƒã‚¯
          if echo "$DIGEST" | grep -q "è©²å½“ã™ã‚‹è¨˜äº‹ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ\|æ–°ã—ã„æ›´æ–°ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ"; then
            curl -X POST "$AI_SLACK_WEBHOOK_URL" \
              -H 'Content-Type: application/json' \
              -d '{"text":"ğŸ“­ ä»Šæ—¥ã®é‡è¦ãªæ›´æ–°ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆé–¾å€¤: 70ç‚¹ä»¥ä¸Šï¼‰"}'
            exit 0
          fi

          # Markdown ã‚’ JSON ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼ˆSlack ã®æ–‡å­—æ•°åˆ¶é™ã‚’è€ƒæ…®ï¼‰
          DIGEST_TRUNCATED=$(echo "$DIGEST" | head -c 2900)
          if [ ${#DIGEST} -gt 2900 ]; then
            DIGEST_TRUNCATED="$DIGEST_TRUNCATED\n\n_... (çœç•¥)_"
          fi

          ESCAPED=$(echo "$DIGEST_TRUNCATED" | jq -Rs .)

          curl -X POST "$AI_SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"ğŸ“¬ ä»Šæ—¥ã®é‡è¦ãªæ›´æ–° (AIåˆ†ææ¸ˆã¿)\",
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": $ESCAPED
                  }
                }
              ]
            }"

      - name: Notify on failure
        if: failure()
        env:
          AI_SLACK_WEBHOOK_URL: ${{ secrets.AI_SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST "$AI_SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d '{"text":"ğŸš¨ *Update Watcher ãŒå¤±æ•—ã—ã¾ã—ãŸ*\nãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸã€‚GitHubã®Actions ã‚¿ãƒ–ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œãƒšãƒ¼ã‚¸>"}'
